import numpy as np
import glob
import pickle

chan_id = [92,  93,  94,  95,  88,  89,  90,  91, 
           84,  85,  86,  87,  80,  81,  82,  83,  
           28,  29,  30,  31,  24,  25,  26,  27,  
           20,  21,  22,  23,  16,  17,  18,  19,  
           76,  77,  78,  79,  72,  73,  74,  75,  
           68,  69,  70,  71,  64,  65,  66,  67,  
           12,  13,  14,  15,  8,  9,  10,  11,  
           4,  5,  6,  7,  0,  1,  2,  3,  220,  
           221,  222,  223,  216,  217,  218,  219, 
           212,  213,  214,  215,  208,  209,  210,  
           211,  156,  157,  158,  159,  152,  153,  
           154,  155,  148,  149,  150,  151,  144,  
           145,  146,  147,  204,  205,  206,  207,  
           200,  201,  202,  203,  196,  197,  198,  
           199,  192,  193,  194,  195,  140,  141,  
           142,  143,  136,  137,  138,  139,  132,  
           133,  134,  135,  128,  129,  130,  131,  
           252,  253,  254,  255,  248,  249,  250,  
           251,  244,  245,  246,  247,  240,  241,  
           242,  243,  188,  189,  190,  191,  184,  
           185,  186,  187,  180,  181,  182,  183,  
           176,  177,  178,  179,  236,  237,  238,  
           239,  232,  233,  234,  235,  228,  229,  
           230,  231,  224,  225,  226,  227,  172,  
           173,  174,  175,  168,  169,  170,  171,  
           164,  165,  166,  167,  160,  161,  162,  
           163,  124,  125,  126,  127,  120,  121,  
           122,  123,  116,  117,  118,  119,  112,  
           113,  114,  115,  60,  61,  62,  63,  56,  
           57,  58,  59,  52,  53,  54,  55,  48,  
           49,  50,  51,  108,  109,  110,  111,  104,
           105,  106,  107,  100,  101,  102,  103,  
           96,  97,  98,  99,  44,  45,  46,  47,  
           40,  41,  42,  43,  36,  37,  38,  39,  
           32,  33,  34,  35]

slot_id = array([ 4,  4,  4,  4,  4,  4,
                  4,  4,  4,  4,  4,  4,  
                  4,  4,  4,  4,  2,
        2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2, 16, 16,
       16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 14, 14, 14,
       14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14,  3,  3,  3,  3,
        3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  1,  1,  1,  1,  1,
        1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 15, 15, 15, 15, 15, 15,
       15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 13, 13, 13, 13, 13, 13, 13,
       13, 13, 13, 13, 13, 13, 13, 13, 13,  8,  8,  8,  8,  8,  8,  8,  8,
        8,  8,  8,  8,  8,  8,  8,  8,  6,  6,  6,  6,  6,  6,  6,  6,  6,
        6,  6,  6,  6,  6,  6,  6, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12,
       12, 12, 12, 12, 12, 12, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,
       10, 10, 10, 10, 10,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,
        7,  7,  7,  7,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,
        5,  5,  5, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11,
       11, 11,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,
               9])

fpga_dict = {'10161420452671572' : 8,
           '10362099439906844' : 6,
           '13547143200256028' : 1,
           '1354900185165844'  : 15,
           '13759032190185500' : 11,
           '13774983532556316' : 5,
           '15780492741586972' : 12,
           '15808512172929116' : 14, 
           '20310480648056916' : 13,
           '2269693859475484' : 4,
           '2516293578010644' : 7,
           '29389679799218268' : 16,
           '4521493673160724' : 2,
           '6801312918188124' : 3,
           '9053112731873364' : 10,
           '9192752332517468' : 9}


fpga_list = ['10161420452671572',
           '10362099439906844',
           '13547143200256028',
           '1354900185165844',
           '13759032190185500',
           '13774983532556316',
           '15780492741586972',
           '15808512172929116',
           '20310480648056916',
           '2269693859475484',
           '2516293578010644',
           '29389679799218268',
           '4521493673160724',
           '6801312918188124',
           '9053112731873364',
           '9192752332517468'] 

fn = '/home/chime/gains_15780492741586972.pkl'
gain_files = glob.glob('/home/chime/gains/gains_*')

def read_pkl(fn):
     f = open(fn)   

     return pickle.load(f)

def write_pkl(fnout, data):
     output = open(fnout, 'w')
     pickle.dump(data, output)
     output.close()

def phase_mult(data_pkl, phase, inp):
     data_pkl[inp][1][0] *= np.exp(-1j * phase)

     return data_pkl[inp][1][0]

def apply_gain(data_pkl, gains, N):
     phase_arr = np.angle(gains)

     for ii in range(N):
          data_pkl[ii][1][0] = phase_mult(data_pkl, phase_arr[:, ii], ii)

     return data_pkl

infile = '/home/chime/gains/gains_'
#infile = './datah5/gains_'

ch_map = [12, 13, 14, 15, 8, 9, 10, 11, 4, 5, 6, 7, 0, 1, 2, 3]

for fpga_name in fpga_list:
     data_pkl = read_pkl(infile + fpga_name + '.pkl')
     x=fpga_dict[fpga_name]
     
     feeds = np.where(slot_id==x)[0]#[::-1]
     feeds = feeds[ch_map]
     g = Gains[:, feeds]

     print feeds
     for i in range(16):
          data_pkl = apply_gain(data_pkl, g, 16)

     print data_pkl
     # Write pickle
     outfile =  './datah5/gains_' + fpga_name + '.pkl'
     write_pkl(outfile, data_pkl)
     print "=================================="

     print "Wrote to ", outfile 

     print "=================================="

     print ""







